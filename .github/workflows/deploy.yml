name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

env:
  PROJECT_NAME: birthdaySite

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          set -euo pipefail

          rm -rf deploy
          mkdir -p deploy

          # Root deployment files
          cp --parents docker-compose.yml deploy/

          # API: copy only source needed for Docker build context (exclude build artifacts and local db)
          rsync -a \
            --exclude='bin/' \
            --exclude='obj/' \
            --exclude='Logs/' \
            --exclude='*.db' \
            apps/api/Birthday/ deploy/apps/api/Birthday/

          # Web: copy only files required by apps/web/Dockerfile
          cp --parents \
            apps/web/Dockerfile \
            apps/web/package.json \
            apps/web/angular.json \
            apps/web/tsconfig.json \
            apps/web/tsconfig.app.json \
            apps/web/tsconfig.spec.json \
            deploy/

          rsync -a apps/web/src/ deploy/apps/web/src/
          rsync -a apps/web/public/ deploy/apps/web/public/

          tar -czf deploy.tar.gz -C deploy .

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: 'deploy.tar.gz'
          target: '~/deployments/${{ env.PROJECT_NAME }}/'

      - name: Extract and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            cd ~/deployments/${{ env.PROJECT_NAME }}

            # Stop existing containers
            docker compose down || true

            # Extract deployment package
            rm -rf .deploy-release
            mkdir -p .deploy-release
            tar -xzf deploy.tar.gz -C .deploy-release
            rm deploy.tar.gz

            # Sync only deployment files and keep server-specific secrets/data
            rsync -a --delete \
              --exclude='.env' \
              --exclude='apps/api/Birthday/*.db' \
              .deploy-release/ ./
            rm -rf .deploy-release

            # Build and start containers (sequential to reduce memory pressure)
            docker compose build api
            docker compose build web
            docker compose up -d

            # Verify deployment
            sleep 10
            if docker compose ps | grep -q "Up"; then
              echo "Deployment successful!"
              docker compose ps
            else
              echo "Deployment failed!"
              docker compose logs
              exit 1
            fi

            # Clean up old images and containers
            docker system prune -f

            echo "Deployment completed at $(date)"

      - name: Deployment status
        if: failure()
        run: |
          echo "Deployment failed!"
          exit 1
